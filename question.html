<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMP MOCK TEST - Question (with Chat)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { background:#f4f4f4; font-size:15px;}
    .container {
      max-width:820px; margin:36px auto; background:#fff; border-radius:18px; box-shadow:0 6px 32px rgba(0,0,0,0.08);
      padding:18px 18px 20px 18px; position:relative;
    }
    .icon-main { text-align:center; margin-bottom:10px;}
    .icon-main svg { vertical-align:middle; width:34px; height:34px; margin-right:6px;}
    .icon-main span { font-size:1.1em; vertical-align:middle;}
    .title { font-size:1.23em; font-weight:bold; margin-bottom:12px; text-align:center; letter-spacing:0.01em;}
    .question-header-row { display:flex; align-items:center; justify-content:center; gap:18px; margin:18px 0 10px 0;}
    .question-big { font-size:1.09em; font-weight:bold; color:#1976d2;}
    .level-tag { font-size:1em; font-weight:bold; border-radius:5px; padding:5px 13px; margin-left:8px;}
    .level-Easy { background:#43a047; color:#fff;}
    .level-Moderate { background:#fbc02d; color:#fff;}
    .level-Difficult { background:#d32f2f; color:#fff;}
    .level-Expert { background:#8e24aa; color:#fff;}
    .summary-row { color:#666; font-size:1.06em; margin-bottom:11px; font-weight:bold;}
    .question-main { font-size:1em; margin-bottom:18px; font-weight:400;}
    .answers { margin-bottom:20px;}
    .answer-label { display:block; margin-bottom:13px; font-size:1em; font-weight:400;}
    .answer-label input[type="radio"], .answer-label input[type="checkbox"] { margin-right:10px; }
    .answer-row { display:flex; align-items:center; margin-top:14px; margin-bottom:15px; gap:30px;}
    .answer-btn {
      background:#1976d2; color:#fff; border:none; border-radius:7px; font-size:1em; font-weight:600;
      padding:8px 26px; cursor:pointer;
    }
    .answer-btn:hover { background:#0d47a1;}
    .toggle-explanation-link {
      color:#1976d2; background:none; border:none; font-size:1em; font-weight:bold;
      cursor:pointer; text-decoration:underline; margin-left:6px;
    }
    .toggle-explanation-link:hover { color:#0d47a1; }
    .status { font-weight:bold; display:inline-block; margin-left:18px; padding:2px 18px; border-radius:18px; font-size:1em;}
    .correct { background:#388e3c; color:#fff;}
    .incorrect { background:#fbc02d; color:#000;}
    .explanation { background:#fffde7; border-left:4px solid #fbc02d; padding:11px 14px; margin-top:12px; font-size:0.98em;}
    .correct-answer { color:#388e3c; font-weight:bold;}
    .reference { color:#6a1b9a; background:#ede7f6; display:inline-block; border-radius:6px; padding:3px 10px; font-size:0.95em; margin-bottom:8px; margin-top:4px;}
    .explanation-en { font-style:italic; color:#1976d2; margin-bottom:8px; margin-top:6px; }
    .explanation-vi { color:#222; margin-bottom:5px;}
    .action-buttons-row { display:flex; align-items:center; justify-content:space-between; margin-top:18px;}
    .pagination-controls { display:flex; align-items:center; gap:6px; }
    .pagination-page { font-size:1em; font-weight:bold; color:#1976d2; min-width:44px; text-align:center; }
    .nav-btn, .first-btn, .last-btn {
      padding:7px 14px; font-size:1em; border-radius:5px; border:none; font-weight:600;
      cursor:pointer; min-width:36px; margin-right:4px;
    }
    .nav-btn { background:#616161; color:#fff;}
    .first-btn, .last-btn { background:#2196f3; color:#fff;}
    .nav-btn:disabled, .first-btn:disabled, .last-btn:disabled { background:#bbb; color:#fff;}
    .list-btn {
      background:#388e3c; color:#fff; padding:8px 24px; border:none; border-radius:5px; font-size:1em; font-weight:600; cursor:pointer; margin-right:8px;
    }
    .end-btn {
      background:#d32f2f; color:#fff; padding:8px 24px; border:none; border-radius:5px; font-size:1em; font-weight:600; cursor:pointer;
    }
    .highlight-correct { background: #c8e6c9; font-weight: bold;}
    .highlight-incorrect { background: #fffde7; font-weight: bold;}
    #timer-controls { 
      margin: 0 auto 16px auto; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap:7px;
      background: #f9f6ef;
      border-radius: 8px;
      padding: 7px 12px;
      box-shadow: 0 1.5px 4px rgba(255,193,7,0.07);
      max-width: 520px;
      font-size: 1em;
    }
    #timer-sandglass {
      font-size:1.28em; 
      margin:0 3px 0 0;
      color: #ff9800;
      animation: sandmove 2s infinite linear;
      display:inline-block;
    }
    @keyframes sandmove {
      0%   {transform:rotate(0deg);}
      90%  {transform:rotate(0deg);}
      100% {transform:rotate(180deg);}
    }
    #timer-controls label {font-weight:500; margin:0;}
    #timer-controls input[type="number"] {
      width:30px;
      border-radius:3px;
      border:1px solid #ccc;
      font-size:1em;
      padding:1px 2px;
      margin:0 0 0 3px;
    }
    #start-timer, #reset-timer {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 5px 13px;
      font-weight: bold;
      font-size: 0.97em;
      cursor:pointer;
      transition:background 0.16s;
      margin-left: 0;
    }
    #start-timer:hover, #reset-timer:hover { background: #0d47a1;}
    #reset-timer { background:#bbb; color:#222; }
    #timer-display { font-size:1.09em; margin-left:3px; font-weight:bold; color:#1976d2;}
    #clear-answer-row {
      display: flex;
      justify-content: center;
      margin: 16px 0 0 0;
    }
    #clear-answer {
      background:#ffe082;
      color:#444;
      border:none;
      border-radius:8px;
      font-size:1em;
      font-weight:600;
      padding:8px 18px 8px 14px;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(255,193,7,0.11);
      display: flex;
      align-items: center;
      gap:7px;
      transition: background 0.2s;
    }
    #clear-answer:hover {
      background:#ffd54f;
      color:#222;
    }
    #clear-icon {
      font-size: 1.2em;
    }

    /* CHAT */
    #chat-btn-open {
      position:fixed; bottom:30px; right:35px;
      background: #1976d2; color:#fff; border:none; border-radius:50%; width:46px; height:46px;
      font-size:2em; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 14px rgba(33,150,243,0.13);
      z-index:1011; transition: background 0.18s;
    }
    #chat-btn-open:hover { background: #388e3c;}
    #chat-box {
      display:none; flex-direction:column;
      position:fixed; bottom:90px; right:40px; z-index:1001;
      width:350px; max-width:95vw; height:560px; background:#fff;
      border-radius:14px; box-shadow:0 8px 44px rgba(25,118,210,0.16);
      border:1.5px solid #1976d2; animation:openchat 0.18s;
    }
    @keyframes openchat { 0%{transform:scale(0.6); opacity:0;} 100%{transform:scale(1); opacity:1;}}
    #chat-header {background:#1976d2; color:#fff; border-radius:14px 14px 0 0; padding:11px 18px 8px 18px; font-weight:bold; display:flex; align-items:center; justify-content:space-between;}
    #chat-header-title { font-size:1.08em;}
    #chat-box-close {
      background:#fff; border:none; color:#d32f2f; font-size:1.15em; cursor:pointer; margin-left:10px; border-radius:50%; width:28px; height:28px; line-height:1; text-align:center; box-shadow:0 0 2px #bbb;
      position: absolute; right:10px; top:10px; z-index:10; padding:0;
    }
    #chat-box-close:hover { background:#ffd5d5; color:#b71c1c;}
    #chat-login-area, #chat-main-area { padding:14px 18px 10px 18px;}
    #chat-login-area label { display:block; margin:7px 0 3px 0;}
    #chat-username { width:85%; padding:7px; border-radius:7px; border:1px solid #bbb; margin-bottom:8px;}
    #chat-login-btn { margin-top:9px; background:#43a047; color:#fff; border:none; border-radius:6px; font-size:1em; font-weight:600; padding:7px 18px; cursor:pointer;}
    #chat-logout-btn {
      background:#d32f2f; color:#fff; border:none; border-radius:50%; width:24px; height:24px; font-size:0.98em; font-weight:bold; margin-left:10px; margin-bottom:0;
      position:absolute; top:16px; right:48px; z-index:10; padding:0;
      display:flex;align-items:center;justify-content:center;
      min-width:0; min-height:0;
    }
    #chat-logout-btn:hover { background:#b71c1c;}
    #chat-to-select { width:98%; padding:6px 6px 6px 10px; border-radius:5px; border:1px solid #ccc; margin-bottom:9px;}
    #chat-msgs { background:#f8fafb; border-radius:7px; height:325px; overflow-y:auto; padding:10px 8px 10px 8px; margin-bottom:7px; font-size:0.99em;}
    .chat-msg-you { text-align:right; margin:7px 0;}
    .chat-msg-you .chat-msg-bubble {background:#bbdefb; color:#1976d2;}
    .chat-msg-other { text-align:left; margin:7px 0;}
    .chat-msg-other .chat-msg-bubble {background:#f1f8e9; color:#222;}
    .chat-msg-bubble { display:inline-block; padding:6px 13px; border-radius:14px; max-width:81%; word-break:break-word; margin-bottom:2px; font-size:1em;}
    .chat-msg-username { font-size:0.93em; color:#888; margin-bottom:2px; }
    #chat-msg-form { display:flex; align-items:center; margin-top:7px; position:relative;}
    #chat-msg-input { flex:1; padding:7px; border-radius:7px; border:1px solid #bbb; font-size:1em;}
    #chat-msg-send { background:#1976d2; color:#fff; border:none; border-radius:6px; padding:7px 15px; font-weight:600; margin-left:7px; font-size:1em; cursor:pointer;}
    #chat-emoji-toggle { background:none; border:none; font-size:1.3em; cursor:pointer; margin-left:6px;}
    #chat-emoji-list {
      display:none; position:absolute; bottom:45px; right:65px; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 16px #ccc;
      z-index:2000; padding:7px 9px; min-width:160px; text-align:center;
    }
    #chat-emoji-list button {
      border:none; background:none; font-size:1.45em; margin:2px 4px; cursor:pointer; border-radius:7px; padding:2px 2px;
      transition:background .14s;
    }
    #chat-emoji-list button:hover { background:#eeeeee;}
    #chat-user-list { font-size:0.98em; margin-bottom:7px;}
    #chat-user-list b { color:#43a047;}
    #chat-info {color:#d32f2f; font-size:0.97em; margin:7px 0 0 0;}
    @media (max-width: 500px) {
      #chat-box {width:99vw; right:1vw; bottom:0; max-height:90vh;}
      #chat-main-area, #chat-login-area {padding:10px 4vw;}
      #chat-emoji-list {right:8vw;}
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <div class="icon-main">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" stroke="#1976d2" stroke-width="4" fill="#e3f2fd"/><text x="32" y="41" text-anchor="middle" font-size="32" fill="#1976d2" font-family="Arial" font-weight="bold">?</text></svg>
      <span>üìö</span>
    </div>
    <div class="title">PMP MOCK TEST</div>
    <div id="timer-controls">
      <span id="timer-sandglass">‚è≥</span>
      <label>
        <input type="number" id="minutes" min="0" max="99" value="1"> ph√∫t
        <input type="number" id="seconds" min="0" max="59" value="0"> gi√¢y
      </label>
      <button id="start-timer" type="button">Start</button>
      <button id="reset-timer" type="button">Reset</button>
      <span id="timer-display">01:00</span>
    </div>
    <div class="question-header-row">
      <span class="question-big" id="question-number"></span>
      <span class="level-tag" id="question-level"></span>
    </div>
    <div class="summary-row" id="question-summary"></div>
    <div class="question-main" id="question-main"></div>
    <form id="answers" class="answers"></form>
    <div class="answer-row">
      <button class="answer-btn" id="answer-btn">ANSWER</button>
      <button class="toggle-explanation-link" id="toggle-explanation" type="button">+ Show answer & explanation</button>
      <span id="status" class="status"></span>
    </div>
    <div id="explanation" class="explanation" style="display:none;"></div>
    <div id="clear-answer-row">
      <button id="clear-answer" type="button">
        <span id="clear-icon">üßπ</span> 
        Clear/Reset Answer
      </button>
    </div>
    <div class="action-buttons-row">
      <div class="pagination-controls">
        <button class="first-btn" id="btn-first">&laquo;</button>
        <button class="nav-btn" id="btn-prev">&lt;</button>
        <span class="pagination-page" id="page-label"></span>
        <button class="nav-btn" id="btn-next">&gt;</button>
        <button class="last-btn" id="btn-last">&raquo;</button>
      </div>
      <div>
        <button class="list-btn" id="btn-list">Back to list</button>
        <button class="end-btn" id="btn-end">End</button>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <button id="chat-btn-open" title="T∆∞∆°ng t√°c online">&#128172;</button>
  <div id="chat-box">
    <div id="chat-header">
      <span id="chat-header-title">üí¨ Online Chat</span>
      <button id="chat-logout-btn" title="Tho√°t">&#10060;</button>
      <button id="chat-box-close" title="ƒê√≥ng">&#10006;</button>
    </div>
    <div id="chat-login-area">
      <label>Nh·∫≠p t√™n c·ªßa b·∫°n:</label>
      <input type="text" id="chat-username" maxlength="20" placeholder="T√™n (kh√¥ng tr√πng)">
      <button id="chat-login-btn">V√†o ph√≤ng chat</button>
      <div id="chat-info"></div>
    </div>
    <div id="chat-main-area" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div id="chat-user-list"></div>
      </div>
      <select id="chat-to-select">
        <option value="__all__">üí° Nh√≥m chung (t·∫•t c·∫£)</option>
      </select>
      <div id="chat-msgs"></div>
      <form id="chat-msg-form" autocomplete="off">
        <input id="chat-msg-input" type="text" maxlength="250" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="chat-emoji-toggle" type="button" tabindex="-1">üòä</button>
        <div id="chat-emoji-list">
          <button type="button">üòÄ</button>
          <button type="button">üòÅ</button>
          <button type="button">üòÇ</button>
          <button type="button">ü§£</button>
          <button type="button">üòä</button>
          <button type="button">üòç</button>
          <button type="button">üòé</button>
          <button type="button">üò¢</button>
          <button type="button">üò≠</button>
          <button type="button">üëç</button>
          <button type="button">üôè</button>
          <button type="button">üëè</button>
          <button type="button">üí™</button>
          <button type="button">‚ù§Ô∏è</button>
        </div>
        <button id="chat-msg-send" type="submit">G·ª≠i</button>
      </form>
    </div>
  </div>
  <!-- END CHAT -->

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBQ2HWP1l7SIz3FyQaNz37xEgXiDAStnCs",
      authDomain: "pmptraining-ad18c.firebaseapp.com",
      databaseURL: "https://pmptraining-ad18c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pmptraining-ad18c",
      storageBucket: "pmptraining-ad18c.appspot.com",
      messagingSenderId: "595622352594",
      appId: "1:595622352594:web:1e835cc6fadf45ceedff0b",
      measurementId: "G-9FXNTLV9VV"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === QUIZ D·ªÆ LI·ªÜU DEMO (n·∫øu ch∆∞a c√≥ local) ===
    if (!localStorage.getItem('pmp_questions')) {
      let questions = [
        {
          question: "A company is implementing a new computerized system. During project execution, the leader of a department that is critical to project completion raises a concern that the department's requirements are completely missing from the approved project management plan.\n\nWhat should the project manager have done to avoid this issue?",
          short: "C√¢u h·ªèi ki·ªÉm tra k·ªπ nƒÉng l·∫≠p k·∫ø ho·∫°ch d·ª± √°n, ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c b√™n li√™n quan quan tr·ªçng ƒë·ªÅu ƒë∆∞·ª£c tham gia ƒë·ªÉ kh√¥ng b·ªè s√≥t y√™u c·∫ßu.",
          options: [
            "Managed the expectations of all relevant stakeholders.",
            "Sought expert judgment in the project scope design.",
            "Involved all relevant stakeholders in the project planning.",
            "Developed a change management plan to approve changes."
          ],
          correct: 2,
          reference: "PMBOK Guide Seventh Edition, Stakeholder Planning",
          explanation_en: "If the department leader was not included in project planning activities, seeking expert judgment in the project scope design would not resolve the issue of missing requirements.",
          explanation_vi: "Qu·∫£n l√Ω d·ª± √°n c·∫ßn ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c b√™n li√™n quan quan tr·ªçng ƒë·ªÅu ƒë∆∞·ª£c tham gia v√†o qu√° tr√¨nh l·∫≠p k·∫ø ho·∫°ch d·ª± √°n.",
          difficulty: "Moderate"
        }
      ];
      localStorage.setItem('pmp_questions', JSON.stringify(questions));
      localStorage.setItem('pmp_checked', JSON.stringify([false]));
      localStorage.setItem('pmp_userAnswers', JSON.stringify([null]));
      localStorage.setItem('pmp_current_idx', "0");
    }

    // === TIMER ===
    let timerInterval = null;
    let remainingTime = 60;
    let timerIsActive = false;
    function displayTimer(sec) {
      let m = Math.floor(sec/60).toString().padStart(2,'0');
      let s = (sec%60).toString().padStart(2,'0');
      document.getElementById('timer-display').textContent = `${m}:${s}`;
    }
    function startCountdown() {
      let m = parseInt(document.getElementById('minutes').value) || 0;
      let s = parseInt(document.getElementById('seconds').value) || 0;
      remainingTime = m*60 + s;
      if (remainingTime <= 0) return;
      if(timerIsActive) { clearInterval(timerInterval); }
      displayTimer(remainingTime);
      timerIsActive = true;
      timerInterval = setInterval(()=>{
        remainingTime--;
        displayTimer(remainingTime);
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          timerIsActive = false;
          alert('H·∫æT GI·ªú!');
        }
      },1000);
    }
    function resetTimer() {
      clearInterval(timerInterval);
      timerIsActive = false;
      let m = parseInt(document.getElementById('minutes').value) || 0;
      let s = parseInt(document.getElementById('seconds').value) || 0;
      remainingTime = m*60 + s;
      displayTimer(remainingTime);
    }
    document.getElementById('start-timer').onclick = startCountdown;
    document.getElementById('reset-timer').onclick = resetTimer;
    window.addEventListener('DOMContentLoaded', ()=>{ resetTimer(); });

    // === QUIZ LOGIC ===
    let questions = [];
    let current = 0;
    let userAnswers = [];
    let checked = [];
    let showExplanation = [];
    function levelTag(level) {
      let txt = level || "Moderate";
      let className = "level-" + txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase();
      return `<span class="level-tag ${className}">${txt}</span>`;
    }
    function getMultiCount(text, options) {
      let lower = text.toLowerCase();
      let m = lower.match(/choose\s+(two|three|four|five|\d+|all)/) ||
              lower.match(/select\s+(two|three|four|five|\d+|all)/) ||
              lower.match(/(pick|mark)\s+(two|three|four|five|\d+|all)/);
      if (m) {
        let val = m[1] || m[2];
        if (val === "two") return 2;
        if (val === "three") return 3;
        if (val === "four") return 4;
        if (val === "five") return 5;
        if (val === "all") return options ? options.length : 2;
        if (!isNaN(val)) return Number(val);
      }
      return 1;
    }
    function renderQuestion() {
      const q = questions[current];
      let multiCount = getMultiCount(q.question, q.options);
      document.getElementById("question-number").textContent = `Question#${current+1}`;
      document.getElementById("question-level").innerHTML = levelTag(q.difficulty);
      document.getElementById("question-summary").innerHTML = `<b>Summary:</b> ${q.short||""}`;
      document.getElementById("question-main").innerHTML = q.question.replace(/\n/g,'<br>');
      let ansHtml = "";
      if (multiCount > 1) {
        let arr = Array.isArray(userAnswers[current]) ? userAnswers[current] : [];
        q.options.forEach((option, i) => {
          ansHtml += `<label class="answer-label" id="label${i}">
            <input type="checkbox" name="q${current}" value="${i}" ${(arr.includes(i)) ? 'checked' : ''} ${checked[current] ? 'disabled' : ''} onchange="updateMultiAnswer(${i})">
            ${String.fromCharCode(65+i)}. ${option}
          </label>`;
        });
      } else {
        q.options.forEach((option, i) => {
          ansHtml += `<label class="answer-label" id="label${i}">
            <input type="radio" name="q${current}" value="${i}" ${userAnswers[current] == i ? 'checked' : ''} ${checked[current] ? 'disabled' : ''} onchange="updateSingleAnswer(${i})">
            ${String.fromCharCode(65+i)}. ${option}
          </label>`;
        });
      }
      document.getElementById("answers").innerHTML = ansHtml;
      document.getElementById("status").textContent = "";
      document.getElementById("toggle-explanation").innerHTML = "+ Show answer & explanation";
      document.getElementById("explanation").style.display = showExplanation[current] ? "block" : "none";
      let expHtml = "";
      if (multiCount > 1 && Array.isArray(q.correct)) {
        expHtml = `<span class="correct-hint">ƒê√°p √°n ƒë√∫ng</span>: <span class="correct-answer">${q.correct.map(idx=>String.fromCharCode(65+idx)+'. '+q.options[idx]).join(', ')}</span><br>`;
      } else {
        expHtml = `<span class="correct-hint">ƒê√°p √°n ƒë√∫ng</span>: <span class="correct-answer">${String.fromCharCode(65+q.correct)}. ${q.options[q.correct]}</span><br>`;
      }
      if(q.reference) expHtml += `<span class="reference">Tham kh·∫£o: ${q.reference.replace(/\n/g,"<br>")}</span><br>`;
      if(q.explanation_en) expHtml += `<div class="explanation-en">Gi·∫£i th√≠ch EN: ${q.explanation_en.replace(/\n/g,"<br>")}</div>`;
      if(q.explanation_vi) expHtml += `<div class="explanation-vi">Gi·∫£i th√≠ch Vi: ${q.explanation_vi.replace(/\n/g,"<br>")}</div>`;
      document.getElementById("explanation").innerHTML = expHtml;
      document.getElementById("page-label").textContent = `${current+1} / ${questions.length}`;
      document.getElementById("btn-first").disabled = current===0;
      document.getElementById("btn-prev").disabled = current===0;
      document.getElementById("btn-next").disabled = current===questions.length-1;
      document.getElementById("btn-last").disabled = current===questions.length-1;
      if(checked[current]) showCheckResult();
    }
    window.updateSingleAnswer = function(i) {
      userAnswers[current] = i;
      localStorage.setItem('pmp_userAnswers', JSON.stringify(userAnswers));
    };
    window.updateMultiAnswer = function(i) {
      let arr = Array.isArray(userAnswers[current]) ? userAnswers[current] : [];
      let checkbox = document.querySelector('input[type=checkbox][name="q'+current+'"][value="'+i+'"]');
      if (checkbox.checked) {
        if (!arr.includes(i)) arr.push(i);
      } else {
        arr = arr.filter(x=>x!==i);
      }
      userAnswers[current] = arr;
      localStorage.setItem('pmp_userAnswers', JSON.stringify(userAnswers));
      const q = questions[current];
      let multiCount = getMultiCount(q.question, q.options);
      let boxes = document.querySelectorAll('input[type=checkbox][name="q'+current+'"]');
      boxes.forEach(box=>{
        if(!arr.includes(Number(box.value)) && arr.length>=multiCount){
          box.disabled = true;
        } else {
          box.disabled = false;
        }
      });
    };
    function showCheckResult() {
      const q = questions[current];
      const multiCount = getMultiCount(q.question, q.options);
      const status = document.getElementById('status');
      for (let i = 0; i < q.options.length; i++) {
        document.getElementById('label'+i).classList.remove("highlight-correct","highlight-incorrect");
      }
      let correct = (multiCount > 1 && Array.isArray(q.correct)) ? q.correct : [q.correct];
      let chosen = (multiCount > 1) ? (Array.isArray(userAnswers[current]) ? userAnswers[current] : []) : [userAnswers[current]];
      let isCorrect = false;
      if (multiCount > 1) {
        isCorrect = Array.isArray(q.correct) && chosen.length === q.correct.length &&
          q.correct.every(idx=>chosen.includes(idx));
      } else {
        isCorrect = chosen[0] === correct[0];
      }
      if (isCorrect) {
        status.textContent = "CORRECT";
        status.className = "status correct";
        correct.forEach(idx=>{
          document.getElementById('label'+idx).classList.add("highlight-correct");
        });
      } else {
        status.textContent = "INCORRECT";
        status.className = "status incorrect";
        chosen.forEach(idx=>{
          if(idx!=null)document.getElementById('label'+idx).classList.add("highlight-incorrect");
        });
        correct.forEach(idx=>{
          document.getElementById('label'+idx).classList.add("highlight-correct");
        });
      }
      let inputs = document.querySelectorAll('.answers input');
      for (let i = 0; i < inputs.length; i++) inputs[i].disabled = true;
    }
    document.getElementById("answer-btn").onclick = function(e) {
      const q = questions[current];
      let multiCount = getMultiCount(q.question, q.options);
      if (checked[current]) return;
      let status = document.getElementById('status');
      if (multiCount > 1) {
        let boxes = document.querySelectorAll('input[type=checkbox][name="q'+current+'"]');
        let arr = [];
        boxes.forEach(b=>{ if(b.checked) arr.push(Number(b.value)); });
        if (arr.length < multiCount) {
          status.textContent = `Please choose ${multiCount} answers!`;
          status.className = "status";
          return;
        }
        userAnswers[current] = arr;
      } else {
        let radios = document.getElementsByName('q'+current);
        let chosen = null;
        for (let i = 0; i < radios.length; i++) {
          if (radios[i].checked) { chosen = parseInt(radios[i].value); break; }
        }
        if (chosen === null) {
          status.textContent = "Please choose an answer!";
          status.className = "status";
          return;
        }
        userAnswers[current] = chosen;
      }
      checked[current] = true;
      showCheckResult();
      localStorage.setItem('pmp_userAnswers', JSON.stringify(userAnswers));
      localStorage.setItem('pmp_checked', JSON.stringify(checked));
    };
    document.getElementById("toggle-explanation").onclick = function() {
      showExplanation[current] = !showExplanation[current];
      document.getElementById("explanation").style.display = showExplanation[current] ? "block" : "none";
      this.innerHTML = showExplanation[current] ? "- Hide answer & explanation" : "+ Show answer & explanation";
    };
    document.getElementById("btn-first").onclick = function() { if(current>0){current=0;renderQuestion();} };
    document.getElementById("btn-prev").onclick = function() { if(current>0){current--;renderQuestion();} };
    document.getElementById("btn-next").onclick = function() { if(current<questions.length-1){current++;renderQuestion();} };
    document.getElementById("btn-last").onclick = function() { if(current<questions.length-1){current=questions.length-1;renderQuestion();} };
    document.getElementById("btn-list").onclick = function() { window.location.href = "questionsList.html"; };
    document.getElementById("btn-end").onclick = function() {
      localStorage.setItem('pmp_userAnswers', JSON.stringify(userAnswers));
      localStorage.setItem('pmp_checked', JSON.stringify(checked));
      window.location.href = "result.html";
    };
    document.getElementById('clear-answer').onclick = function() {
      document.querySelectorAll('input[type=radio][name="q'+current+'"],input[type=checkbox][name="q'+current+'"]').forEach(el=>{
        el.checked = false;
        el.disabled = false;
      });
      userAnswers[current] = (getMultiCount(questions[current].question, questions[current].options) > 1) ? [] : null;
      checked[current] = false;
      localStorage.setItem('pmp_userAnswers', JSON.stringify(userAnswers));
      localStorage.setItem('pmp_checked', JSON.stringify(checked));
      document.getElementById('status').textContent = "";
      document.getElementById('status').className = "status";
      document.getElementById("toggle-explanation").innerHTML = "+ Show answer & explanation";
      document.getElementById("explanation").style.display = "none";
      showExplanation[current] = false;
      let q = questions[current];
      if(q && q.options) {
        for (let i = 0; i < q.options.length; i++) {
          let lbl = document.getElementById('label'+i);
          if(lbl) lbl.classList.remove("highlight-correct","highlight-incorrect");
        }
      }
      let multiCount = getMultiCount(questions[current].question, questions[current].options);
      if(multiCount > 1){
        let boxes = document.querySelectorAll('input[type=checkbox][name="q'+current+'"]');
        boxes.forEach(box=>{ box.disabled = false; });
      }
    };

    window.onload = function() {
      let raw = localStorage.getItem('pmp_questions');
      if (!raw) { window.location.href = "index.html"; return; }
      questions = JSON.parse(localStorage.getItem('pmp_questions'));
      userAnswers = JSON.parse(localStorage.getItem('pmp_userAnswers')||"null") || Array(questions.length).fill(null);
      checked = JSON.parse(localStorage.getItem('pmp_checked')||"null") || Array(questions.length).fill(false);
      showExplanation = Array(questions.length).fill(false);
      current = parseInt(localStorage.getItem('pmp_current_idx') || "0", 10);
      renderQuestion();
    };

    // === CHAT UI ===
    const chatBox = document.getElementById('chat-box');
    const chatBtnOpen = document.getElementById('chat-btn-open');
    const chatBoxClose = document.getElementById('chat-box-close');
    const chatLoginArea = document.getElementById('chat-login-area');
    const chatMainArea = document.getElementById('chat-main-area');
    const chatUsernameInput = document.getElementById('chat-username');
    const chatLoginBtn = document.getElementById('chat-login-btn');
    const chatLogoutBtn = document.getElementById('chat-logout-btn');
    const chatToSelect = document.getElementById('chat-to-select');
    const chatMsgs = document.getElementById('chat-msgs');
    const chatMsgForm = document.getElementById('chat-msg-form');
    const chatMsgInput = document.getElementById('chat-msg-input');
    const chatUserList = document.getElementById('chat-user-list');
    const chatInfo = document.getElementById('chat-info');
    const chatEmojiToggle = document.getElementById('chat-emoji-toggle');
    const chatEmojiList = document.getElementById('chat-emoji-list');
    let myUsername = null, userRef = null;
    let allUsers = {};
    let allMsgs = [];
    let chatListener = null, userListener = null;

    chatBtnOpen.onclick = ()=>{ chatBox.style.display="flex"; }
    chatBoxClose.onclick = ()=>{ chatBox.style.display="none"; }
    chatEmojiToggle.onclick = function(e){
      e.preventDefault();
      chatEmojiList.style.display = (chatEmojiList.style.display==="block") ? "none" : "block";
    };
    document.addEventListener('click', function(e){
      if (!chatEmojiList.contains(e.target) && e.target!==chatEmojiToggle) {
        chatEmojiList.style.display = "none";
      }
    });
    chatEmojiList.querySelectorAll('button').forEach(btn=>{
      btn.onclick = function(e){
        e.preventDefault();
        chatMsgInput.value += this.textContent;
        chatMsgInput.focus();
        chatEmojiList.style.display = "none";
      }
    });
    chatLoginBtn.onclick = function() {
      let name = chatUsernameInput.value.trim();
      if (!name) { chatInfo.textContent="Nh·∫≠p t√™n!"; return; }
      if (/[^a-zA-Z0-9_.-]/.test(name)) { chatInfo.textContent="Ch·ªâ d√πng ch·ªØ, s·ªë, g·∫°ch d∆∞·ªõi, d·∫•u ch·∫•m, g·∫°ch ngang!"; return; }
      chatLoginBtn.disabled = true;
      db.ref('pmpchat/users/'+name).once('value', snap=>{
        if (snap.val()) {
          chatInfo.textContent="T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng!"; chatLoginBtn.disabled=false;
        } else {
          myUsername = name;
          userRef = db.ref('pmpchat/users/'+myUsername);
          userRef.set({online:true, t:Date.now()});
          userRef.onDisconnect().remove();
          chatLoginArea.style.display="none";
          chatMainArea.style.display="";
          chatInfo.textContent="";
          listenUsers();
          listenMsgs();
          updateUserListUI();
        }
      });
    };
    function listenUsers() {
      if (userListener) db.ref('pmpchat/users').off('value', userListener);
      userListener = db.ref('pmpchat/users').on('value', snap=>{
        allUsers = snap.val()||{};
        updateUserListUI();
        updateCombo();
      });
    }
    function updateUserListUI() {
      let arr = Object.keys(allUsers||{}).sort();
      chatUserList.innerHTML = arr.length
        ? '<b>Online:</b> ' + arr.map(n=>n===myUsername?`<span style="color:#1976d2">${n}</span>`:n).join(', ')
        : '<span style="color:#d32f2f">Kh√¥ng c√≥ ai online</span>';
    }
    function updateCombo() {
      let val = chatToSelect.value;
      chatToSelect.innerHTML = '<option value="__all__">üí° Nh√≥m chung (t·∫•t c·∫£)</option>';
      let arr = Object.keys(allUsers||{}).sort().filter(n=>n!==myUsername);
      arr.forEach(n=>{
        chatToSelect.innerHTML += `<option value="${n}">üë§ ${n}</option>`;
      });
      if (arr.length>=2) {
        chatToSelect.innerHTML += `<option value="__group__">üë• Nh√≥m nh·ªè tu·ª≥ ch·ªçn</option>`;
      }
      chatToSelect.value = val;
    }
    function listenMsgs() {
      if (chatListener) db.ref('pmpchat/msgs').off('value', chatListener);
      chatListener = db.ref('pmpchat/msgs').on('value', snap=>{
        allMsgs = [];
        snap.forEach(child=>{ allMsgs.push(child.val()); });
        renderChatMsgs();
      });
    }
    chatMsgForm.onsubmit = function(e){
      e.preventDefault();
      let to = chatToSelect.value;
      let content = chatMsgInput.value.trim();
      if (!content) return;
      let msg = {
        from: myUsername,
        to: to,
        content: content,
        t: Date.now()
      };
      if (to==="__group__") {
        let group = prompt("Nh·∫≠p t√™n c√°c th√†nh vi√™n nh√≥m, ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y (,), VD: user1,user2,user3 (bao g·ªìm c·∫£ b·∫°n n·∫øu mu·ªën)");
        if (!group) return;
        let names = group.split(',').map(s=>s.trim()).filter(Boolean);
        names.forEach(u=>{
          let m2 = {...msg, to:u};
          db.ref('pmpchat/msgs').push(m2);
        });
      } else if (to==="__all__") {
        db.ref('pmpchat/msgs').push(msg);
      } else {
        db.ref('pmpchat/msgs').push(msg);
      }
      chatMsgInput.value="";
    };
    function renderChatMsgs() {
      let sel = chatToSelect.value;
      chatMsgs.innerHTML = '';
      let arr;
      if (sel==="__all__") {
        arr = allMsgs.filter(m=>m.to==="__all__");
      } else if (sel==="__group__") {
        arr = [];
      } else {
        arr = allMsgs.filter(m=>
          (m.from===myUsername && m.to===sel) || (m.from===sel && m.to===myUsername)
        );
      }
      arr = arr.slice(-100);
      arr.forEach(m=>{
        let isMe = m.from===myUsername;
        let div = document.createElement('div');
        div.className = isMe ? 'chat-msg-you' : 'chat-msg-other';
        div.innerHTML =
          (!isMe?`<div class="chat-msg-username">${m.from}</div>`:'') +
          `<span class="chat-msg-bubble">${m.content}</span>`;
        chatMsgs.appendChild(div);
      });
      chatMsgs.scrollTop = chatMsgs.scrollHeight;
    }
    chatToSelect.onchange = renderChatMsgs;
    chatLogoutBtn.onclick = function() {
      if (myUsername && userRef) {
        userRef.remove();
        myUsername = null;
        chatLoginArea.style.display="";
        chatMainArea.style.display="none";
        chatInfo.textContent='';
        chatUsernameInput.value='';
        chatMsgs.innerHTML = '';
        chatToSelect.value="__all__";
      }
    };
    window.addEventListener('beforeunload', function() {
      if (myUsername && userRef) userRef.remove();
    });
  </script>
</body>
</html>